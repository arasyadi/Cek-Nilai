<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai Mata Kuliah | Andy Rasyadi, S.Pi., M.Si.</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/2/2d/Logo-unud-baru.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --background-color: #e9f5f5;
            --card-background: #ffffff;
            --font-color: #333;
            --shadow-color: rgba(0, 95, 115, 0.2);
            --grade-a-color: #2a9d8f;
            --grade-b-color: #e9c46a;
            --grade-c-color: #f4a261;
            --grade-d-color: #e76f51;
            --grade-e-color: #d90429;
            --grade-default-color: #6c757d;
            --success-color: #28a745;
            --whatsapp-color: #25D366;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background-color: var(--card-background);
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            animation: fadeIn 0.8s ease-in-out;
        }
        
        #last-update {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 2.2em;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #nimInput {
            flex-grow: 1;
            padding: 12px 15px;
            font-size: 1em;
            border-radius: 8px;
            border: 2px solid #ccc;
            min-width: 100px; /* Tambahan untuk mencegah terlalu kecil */
        }

        #nimInput:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(10, 147, 150, 0.3);
        }

        #checkButton {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #checkButton:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 95, 115, 0.3);
        }
        
        #checkButton:active {
            transform: translateY(0);
        }
        
        #course-selection-box {
            margin-bottom: 20px;
            animation: slideUp 0.5s ease-in-out;
        }
        #courseSelector {
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            border-radius: 8px;
            border: 2px solid var(--secondary-color);
            background-color: #fff;
        }

        #result {
            margin-top: 20px;
            text-align: left;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            background: #f8f9fa;
            border-left: 5px solid var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideUp 0.5s ease-in-out;
        }
        
        .result-card h3 { color: var(--primary-color); }
        #student-info p { margin: 8px 0; font-size: 1.1em; }
        #student-info strong { display: inline-block; width: 120px; color: #555; }
        #grades-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #grades-table th, #grades-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        #grades-table th { background-color: var(--primary-color); color: white; text-align: center; }
        #grades-table tr:nth-child(even) { background-color: #f2f2f2; }

        .final-grade-card { text-align: center; padding: 25px 20px; }
        .grade-display {
            width: 150px; height: 150px; margin: 15px auto 10px;
            border-radius: 50%; display: flex; justify-content: center;
            align-items: center; font-size: 5em; font-weight: 700;
            color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 5px solid white; opacity: 0;
            animation: gradeReveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s forwards;
        }
        
        .grade-A { background-color: var(--grade-a-color); }
        .grade-B-plus, .grade-B { background-color: var(--grade-b-color); color: #333;}
        .grade-C-plus, .grade-C { background-color: var(--grade-c-color); }
        .grade-D-plus, .grade-D { background-color: var(--grade-d-color); }
        .grade-E { background-color: var(--grade-e-color); }
        .grade-other { background-color: var(--grade-default-color); }

        @keyframes gradeReveal {
            0% { transform: scale(0.3) rotate(-30deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            80% { transform: scale(0.95) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .message { padding: 15px; border-radius: 8px; font-weight: 600; }
        .error { background-color: #fff0f3; color: #d90429; border: 1px solid #d90429; }
        .info { background-color: #eef7ff; color: #005f73; border: 1px solid #005f73; }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.95em;
        }
        
        .btn-whatsapp {
            background-color: var(--whatsapp-color);
            color: white;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }
        
        .btn-print {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-print:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 95, 115, 0.3);
        }
        
        .btn-reset {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .grade-insight {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .grade-insight p {
            margin: 8px 0;
            font-size: 0.95em;
            color: #555;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 0.9em;
        }
        
        .stat-card .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 95, 115, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .search-box, .action-buttons, #checkButton { display: none; }
        }
        
        @media (max-width: 600px) {
            .search-box {
                flex-wrap: wrap;
            }
            .container {
                padding: 20px;
            }
            .header h1 {
                font-size: 1.6em;
            }
            .action-buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MarineScore Checker 🐟</h1>
            <p>Sistem Informasi Pengecekan Nilai Per Mata Kuliah v1.2</p>
			<p>Dibuat oleh: Andy Rasyadi, S.Pi., M.Si.</p>
        </div>

        <div class="search-box">
            <input type="text" id="nimInput" placeholder="Masukkan Nomor Induk Mahasiswa (NIM)..." onkeydown="if(event.key==='Enter') document.getElementById('checkButton').click()">
            <button id="checkButton">Cek Nilai</button>
        </div>

        <div id="last-update"></div>

        <div id="course-selection-box"></div>
        <div id="result"></div>
    </div>

    <script>
        // --- PENGATURAN URL ---
		// URL untuk data nilai utama
		const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTMZOtWPI_--3z-KW696UKS1GwkohfwK4PKdDGJEcqs8zRICMlRvUh3Zh-MwehTlpCdiP-r6mpTrTOi/pub?gid=633003728&single=true&output=csv';
		// URL untuk sheet "Info" yang berisi tanggal update
		const infoUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTMZOtWPI_--3z-KW696UKS1GwkohfwK4PKdDGJEcqs8zRICMlRvUh3Zh-MwehTlpCdiP-r6mpTrTOi/pub?gid=1422727630&single=true&output=csv';
		// Nomor WhatsApp dosen (format: 62xxx tanpa +)
		const dosenWhatsApp = '6281337359423'; // Ganti dengan nomor WA dosen
		const dosenNama = 'Andy Rasyadi, S.Pi., M.Si.';
        
        const nimInput = document.getElementById('nimInput');
        const checkButton = document.getElementById('checkButton');
        const resultDiv = document.getElementById('result');
        const courseSelectionBox = document.getElementById('course-selection-box');
        const lastUpdateDiv = document.getElementById('last-update');

        let studentData = [];
        let currentStudentRecords = [];
        let currentStudent = null;

        window.addEventListener('DOMContentLoaded', () => {
            loadStudentData();
            loadLastUpdate();
            
            // Auto-focus pada input NIM
            nimInput.focus();
        });

        checkButton.addEventListener('click', findStudent);
        
        // Animasi saat load
        nimInput.addEventListener('input', () => {
            if(nimInput.value.length > 0) {
                checkButton.style.transform = 'scale(1.05)';
                setTimeout(() => checkButton.style.transform = 'scale(1)', 200);
            }
        });

        function loadLastUpdate() {
            Papa.parse(infoUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const infoData = results.data;
                    const updateInfo = infoData.find(row => row.Key === 'LastUpdate');
                    if (updateInfo) {
                        lastUpdateDiv.innerText = `Update : ${updateInfo.Value}`;
                    }
                },
                error: (err) => {
                    console.error("Gagal memuat info update:", err);
                    lastUpdateDiv.innerText = "Gagal memuat info pembaruan.";
                }
            });
        }

        function loadStudentData() {
            Papa.parse(dataUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    studentData = results.data;
                    displayMessage('info', 'Selamat datang! Silakan masukkan NIM untuk melihat rekap nilai.');
                },
                error: (err) => {
                    displayMessage('error', 'Gagal memuat data nilai. Pastikan URL dan format CSV sudah benar.');
                }
            });
        }

        function findStudent() {
            const nimToFind = nimInput.value.trim();
            resultDiv.innerHTML = '';
            courseSelectionBox.innerHTML = '';

            if (!nimToFind) {
                displayMessage('error', 'NIM tidak boleh kosong.');
                return;
            }

            currentStudentRecords = studentData.filter(row => row.NIM && row.NIM.trim() === nimToFind);

            if (currentStudentRecords.length === 0) {
                displayMessage('error', `Data untuk NIM <strong>${nimToFind}</strong> tidak ditemukan.`);
            } else if (currentStudentRecords.length === 1) {
                displayGrades(currentStudentRecords[0]);
            } else {
                displayCourseSelector(currentStudentRecords);
            }
        }

        function displayCourseSelector(records) {
            const studentName = records[0].Nama;
            let options = `<option value="">-- Pilih Mata Kuliah untuk an. ${studentName} --</option>`;
            records.forEach((record, index) => {
                options += `<option value="${index}">${record.Mata_Kuliah}</option>`;
            });
            courseSelectionBox.innerHTML = `<select id="courseSelector" onchange="handleCourseSelection(this.value)">${options}</select>`;
        }
        
        function handleCourseSelection(selectedIndex) {
             if(selectedIndex === "") {
                resultDiv.innerHTML = '';
                return;
             }
             const selectedRecord = currentStudentRecords[selectedIndex];
             displayGrades(selectedRecord);
        }

        function displayGrades(student) {
            currentStudent = student;
            const finalGradeValue = student.Grade ? student.Grade.trim() : 'N/A';
            const finalGradeClass = getGradeClass(finalGradeValue);

            const assessmentIndicators = Object.keys(student)
                .filter(key => key.startsWith('Nilai_'))
                .map(key => ({
                    name: key.replace('Nilai_', '').replace(/_/g, ' '),
                    grade: student[key]
                }));
            
            // Hitung statistik nilai
            const numericGrades = assessmentIndicators
                .map(ind => parseFloat(ind.grade))
                .filter(grade => !isNaN(grade));
            
            const avgGrade = numericGrades.length > 0 
                ? (numericGrades.reduce((a, b) => a + b, 0) / numericGrades.length).toFixed(1)
                : 'N/A';
            
            const maxGrade = numericGrades.length > 0 
                ? Math.max(...numericGrades).toFixed(1)
                : 'N/A';
            
            const minGrade = numericGrades.length > 0 
                ? Math.min(...numericGrades).toFixed(1)
                : 'N/A';
            
            let tableRows = '';
            assessmentIndicators.forEach(indicator => {
                tableRows += `<tr><td>${indicator.name}</td><td style="text-align:center;">${indicator.grade || '-'}</td></tr>`;
            });
            
            // Generate insight berdasarkan grade
            const gradeInsight = getGradeInsight(finalGradeValue, avgGrade);
            
            // Generate WhatsApp message
            const waMessage = encodeURIComponent(
                `Selamat Pagi/Siang/Sore Pak ${dosenNama},\n\nSaya ${student.Nama} (NIM: ${student.NIM}) ingin berkonsultasi mengenai nilai mata kuliah ${student.Mata_Kuliah}.\n\nTerima kasih.`
            );
            const waLink = `https://wa.me/${dosenWhatsApp}?text=${waMessage}`;

            resultDiv.innerHTML = `
                <div class="result-card" id="student-info">
                    <h3>? Identitas Mahasiswa</h3>
                    <p><strong>Nama Lengkap:</strong> ${student.Nama}</p>
                    <p><strong>NIM:</strong> ${student.NIM}</p>
                    <p><strong>Mata Kuliah:</strong> ${student.Mata_Kuliah}</p>
                    <p><strong>Program Studi:</strong> ${student.Prodi}</p>
                </div>
                <div class="result-card" id="student-grades">
                    <h3>?? Rincian Nilai</h3>
                    <table id="grades-table">${'<thead><tr><th>Indikator Penilaian</th><th>Nilai</th></tr></thead>'}<tbody>${tableRows}</tbody></table>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Rata-rata</h4>
                            <div class="stat-value">${avgGrade}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Tertinggi</h4>
                            <div class="stat-value">${maxGrade}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Terendah</h4>
                            <div class="stat-value">${minGrade}</div>
                        </div>
                    </div>
                    
                    <div class="final-grade-card">
                        <h3>?? Grade Akhir</h3>
                        <div class="grade-display ${finalGradeClass}">${finalGradeValue}</div>
                        ${gradeInsight}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="${waLink}" target="_blank" class="btn btn-whatsapp">
                            <span>??</span> Konsultasi Dosen
                        </a>
                        <button onclick="window.print()" class="btn btn-print">
                            <span>???</span> Cetak Nilai
                        </button>
                        <button onclick="resetForm()" class="btn btn-reset">
                            <span>??</span> Cek NIM Lain
                        </button>
                    </div>
                </div>
            `;
        }
        
        function getGradeClass(grade) {
            const gradeUpper = grade.toUpperCase();
            if (gradeUpper === 'A') return 'grade-A';
            if (gradeUpper === 'B+') return 'grade-B-plus';
            if (gradeUpper === 'B') return 'grade-B';
            if (gradeUpper === 'C+') return 'grade-C-plus';
            if (gradeUpper === 'C') return 'grade-C';
            if (gradeUpper === 'D+') return 'grade-D-plus';
            if (gradeUpper === 'D') return 'grade-D';
            if (gradeUpper === 'E') return 'grade-E';
            return 'grade-other';
        }
        
        function getGradeInsight(grade, avgGrade) {
            const gradeUpper = grade.toUpperCase();
            let insight = '';
            
            if (gradeUpper === 'A') {
                insight = '<div class="grade-insight"><p><strong>?? Luar Biasa!</strong> Prestasi yang sangat membanggakan. Pertahankan kualitas belajar Anda!</p></div>';
            } else if (gradeUpper === 'B+' || gradeUpper === 'B') {
                insight = '<div class="grade-insight"><p><strong>?? Sangat Baik!</strong> Hasil yang memuaskan. Tingkatkan lagi untuk mencapai nilai maksimal!</p></div>';
            } else if (gradeUpper === 'C+' || gradeUpper === 'C') {
                insight = '<div class="grade-insight"><p><strong>?? Cukup Baik</strong> Masih ada ruang untuk berkembang. Jangan ragu konsultasi dengan dosen!</p></div>';
            } else if (gradeUpper === 'D+' || gradeUpper === 'D' || gradeUpper === 'E') {
                insight = '<div class="grade-insight"><p><strong>?? Perlu Peningkatan</strong> Segera konsultasi dengan dosen untuk strategi belajar yang lebih baik!</p></div>';
            }
            
            return insight;
        }
        
        function resetForm() {
            nimInput.value = '';
            resultDiv.innerHTML = '';
            courseSelectionBox.innerHTML = '';
            currentStudentRecords = [];
            currentStudent = null;
            nimInput.focus();
            displayMessage('info', 'Selamat datang! Silakan masukkan NIM untuk melihat rekap nilai.');
        }

        function displayMessage(type, message) {
            resultDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }
    </script>
</body>
</html>
